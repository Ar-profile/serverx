name: windows

on:
  workflow_dispatch:
  
jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Setting up the environment
      env:
        NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
      run: |
        echo "Setting up environment variables..."
        # Set environment variables on Windows
        echo "NGROK_AUTH_TOKEN=$NGROK_AUTH_TOKEN" >> $GITHUB_ENV
        
    - name: Enable TS

      run: Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server'-name "fDenyTSConnections" -Value 0

    - run: Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

    - run: Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -Value 1

    - run: Set-LocalUser -Name "runneradmin" -Password (ConvertTo-SecureString -AsPlainText "Rabiu2004@" -Force)

    - name: Create Tunnel

    - name: Run install_ngrok.ps1
      run: .\install_ngrok.ps1
    - name: Run ngrok and sleep
      run: |
        .\ngrok.exe tcp 3389
        Start-Sleep -Seconds 86400  # 24 hours in seconds


    - name: Wait for 24 hours
      run: Start-Sleep -Seconds 86400  # 24 hours in seconds

    - name: Ending Session
      run: echo "Windows End MF"
